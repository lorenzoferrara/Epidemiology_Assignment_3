---
title: "TASK 3: Interaction"
author: "Ferrara Lorenzo"
---

```{r include=FALSE}
# knitr::opts_chunk$set( echo=F )
knitr::opts_chunk$set(out.width = '70%')
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(tidy =TRUE)
knitr::opts_chunk$set(message = FALSE)
```

### The nest data from islet “nucli 84” is stored in nucli84.txt. Additionally, the coordinates of the islet are in poly84.txt

### 1. Build a ppp object using the “nucli 84” data.

```{r include=FALSE}
library(spatstat)
```

```{r}
rm(list=ls())
nucli84 <- read.delim("T3/nucli84.txt")

min.X = min(nucli84$X)
min.Y = min(nucli84$Y)
max.X = max(nucli84$X)
max.Y = max(nucli84$Y)

nucli84$X = nucli84$X - min.X
nucli84$Y = nucli84$Y - min.Y

n84=ppp(x = nucli84$X, y = nucli84$Y, range(nucli84$X), range(nucli84$Y))

poligon=read.delim("T3/poly84.txt")

poligon$X = poligon$X - min.X
poligon$Y = poligon$Y - min.Y
pol.illa<-list(x=poligon$X,y=poligon$Y)

min.pX = min(poligon$X)
min.pY = min(poligon$Y)
max.pX = max(poligon$X)
max.pY = max(poligon$Y)

n84p=ppp(nucli84$X,nucli84$Y,poly=pol.illa, range(poligon$X), range(poligon$Y))
```


```{r}
par(mfrow=c(1,1), font = 2, font.axis = 2, font.lab = 4, las = 1, mar = c(0, 0, 2, 0))
plot(n84p,main="Nests")
axis(1,at=c(round(seq(min.pX, max.pX,length=10),digits=0)),
     pos=c(0,0))
axis(2,at=c(round(seq(min.pY, max.pY,length=10),digits=0)),pos=c(min.pX-4,min.pY-50))

```

### 2) Check the interaction pattern.

To check the interaction pattern we look at the L-function $L(r) = \sqrt{\frac{K(r)}{\pi}}$ since it's an estimator whose variance does not depend on r, so it's more stable than other estimators (like F, G and K).

```{r}
E <- envelope(n84p, Lest, nsim = 19, rank = 1, global = TRUE,correction="best")
```

```{r}
plot(E, main = "Global envelopes of L(r)", legend=F)
abline(v=1, lty=3)
```

The observed $L^(r)$ goes above the theoretical function: that means that the observed empty-space between locations is more than the one expected under the hypothesis of HPP. So we're in presence of a regular pattern.
We also notice that the observed line lies outside of the envelopes from $r=1$ on.

### 3) Model the relation between the intensity of the point process and the covariates height and vegetation accounting for the interaction pattern. Interpret the estimates.

Since we have a regular pattern, we will use Gibbs models.

First we try to fit a Hardcore model:

```{r}
#DA CANCELLARE
grid <- read.delim("T2/grid.txt")
grid.veg = read.delim("T2/grid_veg.txt")
veg = as.matrix(read.delim("T2/veg.txt",header=FALSE))
height = as.matrix(read.delim("T2/height.txt", header=FALSE))

Height = im(mat = height, xcol = grid$x, yrow = grid$y)
Vegetation = im(mat = veg, xcol = grid.veg$x, yrow = grid.veg$y)

fitH<-ppm(n84p, ~ Height + Vegetation, Hardcore)
```

```{r}
summary(fitH)
```

We assess the goodness of fit of the model by looking at the theoretical envelopes of $L(r)$ and comparing it with the observed values.

```{r}
E <- envelope(fitH, Lest, nsim = 19, rank = 1, global = TRUE, correction="best")
```

```{r}
plot(E, main = "global envelopes of L(r)")
```

The observed function lies outside the envelopes. Therefore, the Hardcore model does not fit well the data.

So we try using a Strauss model: in the exploratory analysis the observed L-function lies outside the envelope from $r=1$ on, so we to decide which is the best choice for $r$, we'll analyze the profile likelihood with several values from this range.

```{r}
df=data.frame(r=seq(2,15,by=1))
pfit=profilepl(df,Strauss,n84p,~Height + Vegetation)
```

```{r}
plot(pfit, main="Profiling of the Strauss model through logLikelihood")
```

The maximum value is reached at $r=$

```{r}
r.opt = pfit$fit$fitin$interaction$par$r
r.opt
```

So now we can finally etimate the model:

```{r}
fitSt<-ppm(n84p, ~Height + Vegetation, Strauss(r=r.opt))
fitSt
```

and assess his validity:

```{r}
E <- envelope(fitSt, Lest, nsim = 19, rank = 1, global = TRUE,correction="best")
plot(E, main = "global envelopes of L(r)")
```

The observed L-function is inside the envelopes, therefore the Strauss model is valid and we can proceed to interpret it.

```{r}
summary(fitSt)
```

The estimates of its coefficients are 

<!-- ATTENTO CHE SONO IN EXP -->

```{r}
exp(fitSt$coef)
```

```{r}
exp(confint(fitSt))
```