---
title: 'TASK 3: Interaction'
author: "Ferrara Lorenzo"
output: pdf_document
---

```{r include=FALSE}
# knitr::opts_chunk$set( echo=F )
knitr::opts_chunk$set( cache=T )
knitr::opts_chunk$set(out.width = '70%')
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(tidy =TRUE)
knitr::opts_chunk$set(message = FALSE)
```

# Task 3: Interaction

### The nest data from islet “nucli 84” is stored in nucli84.txt. Additionally, the coordinates of the islet are in poly84.txt

### 1. Build a ppp object using the “nucli 84” data.

```{r include=FALSE}
library(spatstat)
```

```{r}
rm(list=ls())
nucli84 <- read.delim("T3/nucli84.txt")

min.X = min(nucli84$X)
min.Y = min(nucli84$Y)
max.X = max(nucli84$X)
max.Y = max(nucli84$Y)

nucli84$X = nucli84$X - min.X
nucli84$Y = nucli84$Y - min.Y

n84=ppp(x = nucli84$X, y = nucli84$Y, range(nucli84$X), range(nucli84$Y))

poligon=read.delim("T3/poly84.txt")

poligon$X = poligon$X - min.X
poligon$Y = poligon$Y - min.Y
pol.illa<-list(x=poligon$X,y=poligon$Y)

min.pX = min(poligon$X)
min.pY = min(poligon$Y)
max.pX = max(poligon$X)
max.pY = max(poligon$Y)

n84p=ppp(nucli84$X,nucli84$Y,poly=pol.illa, range(poligon$X), range(poligon$Y))
```


```{r}
par(mfrow=c(1,1), font = 2, font.axis = 2, font.lab = 4, las = 1, mar = c(0, 0, 2, 0))
plot(n84p,main="Nests")
axis(1,at=c(round(seq(min.pX, max.pX,length=10),digits=0)),
     pos=c(0,0))
axis(2,at=c(round(seq(min.pY, max.pY,length=10),digits=0)),pos=c(min.pX-4,min.pY-50))

```

### 2) Check the interaction pattern.

To check the interaction pattern, we utilize the L-function defined as $L(r) = \sqrt{\frac{K(r)}{\pi}}$ as it is an estimator with a variance that does not vary with respect to $r$. This makes it more stable than other estimators, such as F, G, and K.

```{r}
E <- envelope(n84p, Lest, nsim = 19, rank = 1, global = TRUE,correction="best")
```

```{r}
plot(E, main = "Global envelopes of L(r)", legend=F)
abline(v=1, lty=3)
```

The observed $L^(r)$ goes above the theoretical function, indicating that the observed distance between locations is greater than expected under the assumption of a homogeneous Poisson process. This suggests the presence of a regular pattern. Additionally, we notice that the observed line falls outside of the envelopes from $r=1$ onward.

### 3) Model the relation between the intensity of the point process and the covariates height and vegetation accounting for the interaction pattern. Interpret the estimates.

Since we have a regular pattern, we will use Gibbs models.

First we try to fit a Hardcore model:

```{r}
grid <- read.delim("T2/grid.txt")
grid.veg = read.delim("T2/grid_veg.txt")
veg = as.matrix(read.delim("T2/veg.txt",header=FALSE))
height = as.matrix(read.delim("T2/height.txt", header=FALSE))

Height = im(mat = height, xcol = grid$x, yrow = grid$y)
Vegetation = im(mat = veg, xcol = grid.veg$x, yrow = grid.veg$y)

fitH<-ppm(n84p, ~ Height + Vegetation, Hardcore)
```

```{r}
summary(fitH)
```

We assess the goodness of fit of the model by looking at the theoretical envelopes of $L(r)$ and comparing it with the observed values.

```{r}
E <- envelope(fitH, Lest, nsim = 19, rank = 1, global = TRUE, correction="best")
```

```{r}
plot(E, main = "global envelopes of L(r)", legend=F)
```

The observed function falls outside of the envelopes, indicating that the Hardcore model does not fit the data well. 

As an alternative, we will try using a Strauss model. Our exploratory analysis showed that the observed L-function lies outside the envelope for values of $r$ greater than 1. To determine the optimal value for $r$, we will analyze the profile likelihood using a range of values inside the interval $[1,15]$ and choose the one that provides the best fit to the data.

```{r}
df=data.frame(r=seq(1,15,by=0.5))
pfit=profilepl(df,Strauss,n84p,~Height + Vegetation)
```

```{r}
plot(pfit, main="Profiling of the Strauss model through logLikelihood")
```

```{r}
r.opt = pfit$fit$fitin$interaction$par$r
```

The optimal value is reached at $r=$ `r r.opt`.

So now we can finally estimate the model:

```{r}
fitSt<-ppm(n84p, ~Height + Vegetation, Strauss(r=r.opt))
fitSt
```

and assess his validity:

```{r}
E <- envelope(fitSt, Lest, nsim = 19, rank = 1, global = TRUE,correction="best")
plot(E, main = "global envelopes of L(r)")
```

The observed L-function is inside the envelopes, therefore the Strauss model can be valid and we proceed to interpret it.

```{r}
summary(fitSt, fine = F)
```

The estimates of its coefficients are:

```{r}
fitSt$coef
```

The estimate for the interaction parameter is	$\gamma =$ `r fitSt$coef[4]`. 
The parameter $\gamma$ controls the strength of interaction between points. If $\gamma = 1$ the model
reduces to a Poisson process. If $\gamma = 0$ the model is a hard core process. For values $0 < \gamma < 1$, like in our case, the process exhibits a moderate strength of interaction between the presence of points in different locations.


