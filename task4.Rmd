---
title: "R Notebook"
output: html_notebook
---

# TASK 4: Case-control studies

```{r include=FALSE}
# knitr::opts_chunk$set( echo=F )
knitr::opts_chunk$set(out.width = '70%')
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(tidy =TRUE)
knitr::opts_chunk$set(message = FALSE)
```

### Using the Primary Biliary Cirrhosis data, perform a case-control point pattern analysis. Point locations and marks are stored in *PBCdata.txt” file. Coordinates of the window are in “PBCpoly.txt” file.

The data are:

```{r}
library(spatstat)
rm(list=ls())

pbc.data <- read.delim("T4/PBCdata2.txt")
head(pbc.data)

```


### 1) Create the ppp object.

```{r}

# pbc=ppp(x = pbc.data$x, y = pbc.data$y, range(pbc.data$x), range(pbc.data$y))

poligon=read.delim("T4/PBCpoly.txt")
min.pX = min(poligon$x)
max.pX = max(poligon$x)
min.pY = min(poligon$y)
max.pY = max(poligon$y)

pol.illa<-list(x=poligon$x, y=poligon$y)

pbc.data$marks = factor(pbc.data$marks)

pbc.p = ppp(pbc.data$x,pbc.data$y, poly=pol.illa, range(poligon$x), range(poligon$y), marks = pbc.data$marks)
```

```{r}
cases = split(pbc.p, pbc.data$marks)$case
controls = split(pbc.p, pbc.data$marks)$control

plot(pbc.p$window, main = "Primary Biliary Cirrhosis data")
points(controls, pch = 3, col = "green")
points(cases, pch = 16, col = "red")
legend("right", c("control", "case"), pch = c(3, 16), col=c("green", "red"), bty = "n", cex = 1.2)
```

### 2) Assess the spatial variation of the risk


```{r}
library(sparr)
# chp <- risk(cases,controls, adapt = T) #he's using the log of the ... density
load("chp.RData")
```

We plot the relative risk in logarithmic scale, so the locations colored in red have a Relative risk greater than 1, while locations colored in blue have a Relative risk smaller than 1.

```{r}
M = max(chp$rr)
m = min(chp$rr)

par(mfrow=c(1,1), font = 2, font.axis = 2, font.lab = 4, las = 1, mar = c(0, 0, 1, 0))
plot(chp$rr, gamma = 1.3, main="Relative risk", col=beachcolours(c(m,M)))
```

Let’s use a permutation test to see if there is a significant difference between cases and controls risk, computing on a regular grid the statistic:

$$\hat{T} = |c|\sum_{i=1}^p(\hat{\rho}(s_i) - \hat{\rho}_0)^2$$

where $c$ is the cell of the grid and (under the null hypothesis $\text{H}_0$) $\rho_0=0$.

```{r}
cellsize<-chp$rr$xstep*chp$rr$xstep
rho0<-0 # For Log-densities
```

The value of the statistic is:

```{r}
ratiorho <- cellsize*sum((chp$rr$v-rho0)^2,na.rm=T)
ratiorho
```

```{r}
# Permutation function
perm_rr<-function(){
  new_ch<-rlabel(pbc.p)
  
  num = length(pbc.p$x)
  indices = sample(1:num)
  
  new_cases <- split(new_ch,  f = pbc.p$marks[indices])$case
  new_controls <- split(new_ch, f = pbc.p$marks[indices])$control
  new_chp <- risk(new_cases,new_controls)
  cellsize<-new_chp$rr$xstep*new_chp$rr$ystep
  ratio_perm <- cellsize*sum((new_chp$rr$v-rho0)^2,na.rm=T)
  ratio_perm
}
```

```{r include=FALSE}
nsim<-199
set.seed(2021)
rperm<-sapply(1:nsim,function(i) perm_rr())
```

```{r}
rperm
```

And its p-value (obtained through a permutation approach) is:

```{r}
(sum(rperm > ratiorho)+1)/(nsim+1)
```

So we don't have enough evidence to reject the null hypothesis.

### 3) Compare the interaction patterns.

We draw the K-functions for cases and controls:

```{r}
s=seq(0,1400,by=100)
khcases<-Kest(cases, r=s, correction="best")
khcontrols<-Kest(controls, r=s, correction="best")
```

```{r}
plot(khcases, legend=T)
lines(khcontrols$r,khcontrols$iso,lty=2, col="blue")
```

```{r}
Kdif<-function(X, r, cr="iso")
{
  k1<-Kest(X[marks(X)=="case"], r=r, correction=cr)
  k2<-Kest(X[marks(X)=="control"], r=r, correction=cr)
  D=k1[[cr]]-k2[[cr]]
  res<-data.frame(r=r, D=D)
  return(fv(res, valu="D", fname="D"))
}

nsim<-39
envKdif<-envelope(pbc.p, Kdif, r=s ,nsim=nsim, savefuns=TRUE,simulate=expression(rlabel(pbc.p)))
```

```{r}
plot(envKdif,legend=F)
```

```{r}
simfuns<-as.data.frame(attr(envKdif, "simfuns"))[,-1]
```

```{r}
khcovdiag<-apply(simfuns, 1, var)
```

```{r}
T0<-sum( ((khcases$iso-khcontrols$iso)/sqrt(khcovdiag))[-1])
```

```{r}
T_pm<-apply(simfuns, 2, function(X){
  sum((X/sqrt(khcovdiag))[-1])
})
```

```{r}
pvalue<-2*(sum(abs(T_pm)>abs(T0))+1)/(nsim+1)
pvalue
```

so we cannot say that the interaction pattern is different between cases and control

